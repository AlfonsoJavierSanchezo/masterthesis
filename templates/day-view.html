<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highcharts with Radio Button and Dropdown</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            margin: 20px;
        }
        .controls {
            margin-bottom: 20px;
        }
        #chart-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
        }
        .table-structure {
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
        }
        .table-structure div {
            flex: 1;
            text-align: center;
            border: 1px solid #ccc;
            padding: 10px;
            margin: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <form class="controls" action="/" method="post">
            <input type="radio" id="live" name="data-type" value="live" checked>
            <label for="daily">Live data</label>
            <input type="radio" id="monthly" name="data-type" value="monthly">
            <label for="monthly">Monthly statistics</label>
            <select id="options-dropdown" name="selected-option">
                {% for farm in farms %}
                <option value="{{farm}}">{{farm|safe}}</option>
                {% endfor %}
            </select>
            <button type="submit-button" onclick="saveState();">Submit</button>
            <div>Or look into the <a href="/database">database</a></div>
        </form>

        <div id="target_div"></div>

        <div class="table-structure">
            <div>
                Performance (Expected/produced)
		<div class="data" id="performance-data">{{Percentage}}</div>
            </div>
            <div>
                Production (kW)
		<div class="data" id="production-data">{{Power}}</div>
            </div>
            <div>
                Irradiance (kW/m²)
		<div class="data" id="irradiance-data">{{Irradiance}}</div>
            </div>
            <div>
                Cell temperature (Cº)
		<div class="data" id="cell-temperature-data">{{Temperature}}</div>
            </div>
            <div>
                Voltage (V)
		<div class="data" id="voltage-data">{{Voltage}}</div>
            </div>
            <div>
                Intensity (A)
		<div class="data" id="intensity-data">{{Intensity}}</div>
            </div>
        </div>
    </div>
    <script>
	let chart;
    let currentFarm

    function saveState(){
        const dropdown = document.getElementById('options-dropdown');
        currentFarm= dropdown.value;
    }

    function checkDropdownOptions() {
        const dropdown = document.getElementById('options-dropdown');
        const submitButton = document.getElementById('submit-button');
        if (dropdown.options.length === 0) {
            submitButton.disabled = true;
        } else {
            submitButton.disabled = false;
        }
    }
        // Initial check when the page loads
    async function requestData() {
    console.log('Called the functions');
    const result = await fetch('http://localhost:5000/newpoints');
    if (result.ok) {
        const data = await result.json();
        console.log('Raw data from server:', data);
        const dropdown = document.getElementById('options-dropdown');
        const farmInfo = data[currentFarm];
        console.log('Parsed data for selected farm:', farmInfo);

        // Check if the new point is different from the last point
        const lastPoint = chart.series[0].data[chart.series[0].data.length - 1];
	    const newPoint = [farmInfo.date, farmInfo.Power]
        const newPoint2 = [farmInfo.date, farmInfo.predict_power]
	    console.log('Last point:', lastPoint);
        if (lastPoint.x !== newPoint[0] || lastPoint.y !== newPoint[1]) {
	    console.log('Adding new point:', newPoint);
            chart.series[0].addPoint(newPoint, true);
            chart.series[1].addPoint(newPoint2, true);
        } else {
            console.log('New point is the same as the last point. Skipping addition.');
        }
        // Call it again after one second
        setTimeout(requestData, 1000);
    	document.getElementById("performance-data").innerHTML = (farmInfo.predict_power/farmInfo.Power).toString()+"%";
    	document.getElementById("intensity-data").innerHTML = farmInfo.Intensity.toString();
    	document.getElementById("voltage-data").innerHTML = farmInfo.Voltage.toString();
    	document.getElementById("production-data").innerHTML = farmInfo.Power.toString();
    	document.getElementById("cell-temperature-data").innerHTML = farmInfo.PanelTemperature.toString();
    	document.getElementById("irradiance-data").innerHTML = farmInfo.Irradiance.toString();
    } else {
        console.error('Failed to fetch data:', result.statusText);
        setTimeout(requestData, 1000);
    }
    //This should only execute with live data so let's update the table values
}
	document.addEventListener('DOMContentLoaded', function () {
        var chartConfig = {
            chart: {
                type: 'line',
                events: {
                    'load': requestData   //Set the event load attribute to the requestData function
                }
            },
            title: {
                text: '{{title}}'
            },
            xAxis: {
                type: 'datetime',
                title: {
                    text: 'Datetime'
                },
                dateTimeLabelFormats: {
                            minute: '%Y-%m-%d %H:%M',
                            hour: '%Y-%m-%d %H:%M',
                            day: '%Y-%m-%d',
                            week: '%Y-%m-%d',
                            month: '%Y-%m',
                            year: '%Y'}
            },
            yAxis: {
                title: {
                    text: 'KWatts'
                }
            },
            series: {{DayData|safe}}
        }
            chart= Highcharts.chart('target_div', chartConfig);
        });
	
    </script>
    {{errormsg}}
</body>
</html>

